<div class="page-layout">
  <div class="left-column">
    <div class="date-header">
      <div class="today-date">
        <%= Date.current.strftime("%-m.%-d(%a)") %>
      </div>
      <div class="random-message">
        <%= @random_message %>
      </div>
    </div>
    <div class="scrollable-area">
      <div class="task-list-wrapper">
        <h4>TO DO</h4>
        <div class="task-list">
          <% @in_progress_tasks.each do |task| %>
            <div class="task-card">
              <div class="dropdown">
                <button class="dropdown-toggle">⋯</button>
                <div class="dropdown-menu">
                  <%= link_to '今日の記録をつける', task_path(task), class: 'dropdown-item' %>
                  <%= link_to '編集', edit_task_path(task), class: 'dropdown-item' %>
                  <%= link_to '削除', task_path(task), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'dropdown-item' %>
                </div>
              </div>
              <div class="progress-circle">
                <div class="fill" style="background: conic-gradient(<%= task.color_code %> <%= task.completion_rate %>%, #ffffff <%= task.completion_rate %>%, #ffffff 100%);"></div>
                <% image_file = task_category_image_map[task.category] || "default.png" %>
                <img class="icon" src="<%= asset_path(image_file) %>" alt="Task">
              </div>
              <div class="task-title">
                <%= task.title %>
              </div>
            </div>
          <% end %>
          <%= link_to '新規作成', new_task_path %>
        </div>
      
        <h4>完了したタスク</h4>
        <div class="task-list">
          <% @completed_tasks.each do |task| %>
            <div class="task-card" style="border-left: 8px solid <%= task.color_code %>;">
              <h4><%= task.title %></h4>
              <p>カテゴリ: <%= task.category %></p>
              <p>期間: <%= task.start_date&.to_date %> ～ <%= task.end_date&.to_date %></p>
              <p>進捗: <%= task.completion_rate %>％</p>
              <div class="actions">
                <%= link_to '表示', task_path(task) %> |
                <%= link_to '編集', edit_task_path(task) %> |
                <%= link_to '削除', task_path(task), method: :delete, data: { confirm: '本当に削除しますか？' } %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="right-column">
    <div class="calendar-wrapper">
      <h4>CALENDAR</h4>
      <div class="calender-container">
        <table class="calendar">
          <thead>
            <tr>
              <th>日</th>
              <th>月</th>
              <th>火</th>
              <th>水</th>
              <th>木</th>
              <th>金</th>
              <th>土</th>
            </tr>
          </thead>
          <tbody>
          <% @current_month_dates.each_slice(7) do |week| %>
            <tr>
              <% week.each do |date| %>
                <td class="<%= 'checked' if @tasks.any? { |task| task.task_logs.exists?(executed_on: date) } %>">
                  <div class="task-background">
                    <% tasks_on_date = @tasks.select { |task| task.task_logs.exists?(executed_on: date) } %>
                    <% tasks_on_date.each_with_index do |task, index| %>
                      <span class="task-span" style="background-color: <%= task.color_code %>; width: <%= 100 / tasks_on_date.size %>%;"></span>
                    <% end %>
                  </div>
                  <div class="date-number">
                    <strong><%= date.day %></strong>
                  </div>
                </td>
              <% end %>
            </tr>
          <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="graph-wrapper">
      <h4>GRAPH</h4>
      <div class="graph-container">
        <%= column_chart(
              @progress_data.map { |date, progress| [date.strftime("%m/%d"), progress] },
              height: "200px",
              stacked: true
            )
        %>
      </div>
    </div>
  </div>
</div>
